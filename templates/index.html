<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arkham Versus Draft</title>
    <style>
        body {
            font-family: Georgia, serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
            background-color: #1a1a1a;
            color: #e8d5b7;
        }
        
        .header {
            background-color: #2c1810;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #8b4513;
        }
        
        .nav {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .nav a {
            color: #e8d5b7;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            transition: color 0.3s ease;
        }
        
        .nav a:hover {
            color: #daa520;
        }
        
        .nav a.current {
            color: #daa520;
            border-bottom: 2px solid #daa520;
            padding-bottom: 2px;
        }
        
        .main-content {
            padding: 0 20px 20px;
        }
        h1 {
            color: #d4af37;
            text-align: center;
            margin-bottom: 30px;
        }
        .cycles-container {
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 1200px) {
            .cycles-container {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        @media (max-width: 900px) {
            .cycles-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        @media (max-width: 600px) {
            .cycles-container {
                grid-template-columns: 1fr;
            }
        }
        .cycle-group {
            margin-bottom: 15px;
            background-color: #2a2a2a;
            border-radius: 6px;
            border: 1px solid #444;
            padding: 10px;
            break-inside: avoid;
        }
        /* Special cycle styling */
        .cycle-group[data-cycle="50"] { /* Return to... */
            background-color: #2a2722;
            border-color: #5a5245;
        }
        .cycle-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 3px;
            font-weight: bold;
            color: #d4af37;
        }
        .cycle-checkbox {
            margin-right: 10px;
            transform: scale(1.3);
        }
        .cycle-packs {
            margin-left: 20px;
        }
        .pack-item {
            display: flex;
            align-items: center;
            padding: 5px;
            margin-bottom: 3px;
            background-color: #3a3a3a;
            border-radius: 4px;
            border: 1px solid #555;
        }
        .pack-item:hover {
            background-color: #4a4a4a;
        }
        .pack-checkbox {
            margin-right: 10px;
            transform: scale(1.1);
        }
        .pack-label {
            cursor: pointer;
            flex: 1;
            margin-right: 8px;
            font-size: 0.95em;
        }
        .quantity-controls {
            display: none;
            align-items: center;
            transition: opacity 0.3s;
        }
        .quantity-controls.enabled {
            display: flex;
            opacity: 1;
        }
        .quantity-label {
            font-size: 0.9em;
            color: #ccc;
            margin-right: 5px;
        }
        .quantity-input {
            width: 60px;
            padding: 4px 8px;
            background-color: #2a2a2a;
            border: 1px solid #666;
            border-radius: 3px;
            color: #e0e0e0;
            text-align: center;
            font-size: 0.9em;
        }
        .quantity-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        label {
            cursor: pointer;
            flex: 1;
        }
        .cycle-label {
            cursor: pointer;
            flex: 1;
            font-size: 1.1em;
        }
        .download-link {
            display: block;
            text-align: center;
            margin: 0 auto 15px auto;
            color: #6699cc;
            text-decoration: underline;
            font-size: 14px;
            padding: 8px;
            transition: color 0.3s;
        }
        .download-link:hover {
            color: #88bbee;
        }
        .download-link.disabled {
            color: #444;
            text-decoration: none;
            cursor: not-allowed;
            pointer-events: none;
        }
        .draft-now-button {
            display: block;
            width: 200px;
            margin: 0 auto;
            padding: 15px 30px;
            background-color: #006400;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .draft-now-button:hover {
            background-color: #008000;
        }
        .draft-now-button:disabled {
            background-color: #444;
            cursor: not-allowed;
        }
        
        .draft-dropdown {
            position: relative;
            display: inline-block;
            margin: 0 auto;
        }
        
        .draft-main-button {
            display: flex;
            align-items: center;
            width: 200px;
            background-color: #006400;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            overflow: hidden;
        }
        
        .draft-main-button:hover {
            background-color: #008000;
        }
        
        .draft-main-button:disabled {
            background-color: #444;
            cursor: not-allowed;
        }
        
        .draft-main-button.disabled {
            background-color: #444;
            cursor: not-allowed;
        }
        
        .draft-main-button.disabled:hover {
            background-color: #444;
        }
        
        .draft-main-button.disabled .draft-button-text {
            cursor: not-allowed;
        }
        
        .draft-main-button.disabled .draft-button-icon {
            cursor: not-allowed;
        }
        
        .draft-main-button.disabled .draft-button-icon:hover {
            background-color: transparent;
        }
        
        .draft-button-text {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
        }
        
        .draft-button-icon {
            padding: 15px 15px;
            border-left: 1px solid rgba(255,255,255,0.2);
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .draft-button-icon:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .draft-dropdown-arrow {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .draft-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .draft-dropdown-content.show {
            display: block;
        }
        
        .draft-option {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #e8d5b7;
            text-decoration: none;
            transition: background-color 0.3s;
            gap: 10px;
            font-size: 16px;
        }
        
        .draft-option:hover {
            background-color: #3a3a3a;
            color: #e8d5b7;
        }
        
        .draft-option:first-child {
            border-radius: 5px 5px 0 0;
        }
        
        .draft-option:last-child {
            border-radius: 0 0 5px 5px;
        }
        
        .draft-option-icon {
            font-size: 18px;
            width: 20px;
        }
        .select-all {
            text-align: center;
            margin-bottom: 20px;
        }
        .select-all button {
            background-color: #444;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .select-all button:hover {
            background-color: #555;
        }
        .footer {
            margin-top: 40px;
            padding: 20px;
            background-color: #2a2a2a;
            border-radius: 5px;
            border: 1px solid #444;
            text-align: center;
            font-size: 0.9em;
            color: #ccc;
            line-height: 1.5;
        }
        .footer a {
            color: #d4af37;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        .error-message {
            background-color: #4a1a1a;
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .error-message h3 {
            color: #ff6b6b;
            margin: 0 0 10px 0;
        }
        .error-message p {
            color: #ffcccc;
            margin: 5px 0;
        }
        
        .options-section, .instructions-section {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .options-header, .instructions-header {
            background-color: #3a3a3a;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            transition: background-color 0.3s ease;
        }
        
        .options-header:hover, .instructions-header:hover {
            background-color: #454545;
        }
        
        .options-header h3, .instructions-header h3 {
            margin: 0;
            color: #d4af37;
            font-size: 18px;
        }
        
        .options-toggle, .instructions-toggle {
            font-size: 20px;
            color: #d4af37;
            transition: transform 0.3s ease;
        }
        
        .options-toggle.expanded, .instructions-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .options-content, .instructions-content {
            display: none;
            padding: 20px;
        }
        
        .options-content.expanded, .instructions-content.expanded {
            display: block;
        }
        
        .option-group {
            margin-bottom: 20px;
        }
        
        .option-group:last-child {
            margin-bottom: 0;
        }
        
        .option-label {
            display: block;
            color: #e8d5b7;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .option-input {
            width: 100%;
            padding: 10px;
            background-color: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e8d5b7;
            font-family: Georgia, serif;
            box-sizing: border-box;
        }
        
        .option-input:focus {
            outline: none;
            border-color: #d4af37;
        }
        
        .option-textarea {
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }
        
        .option-number {
            width: 100px;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <nav class="nav">
            <a href="/" class="current">Draft Generator</a>
            <a href="/deck-exporter">Deck Exporter</a>
        </nav>
    </div>
    <div class="main-content">
        <h1>Arkham Versus Draft</h1>
        <p style="text-align: center; color: #c09020; font-style: italic; margin-top: -10px; margin-bottom: 30px; font-size: 18px;">
            Team-Based, Competitive Drafting for Arkham Horror: The Card Game
        </p>
    
        <!-- Instructions Section -->
        <div class="instructions-section">
            <div class="instructions-header" onclick="toggleInstructions()">
                <h3>Instructions</h3>
                <span class="instructions-toggle" id="instructionsToggle">â–¼</span>
            </div>
            <div class="instructions-content" id="instructionsContent">
                <ol>
                    <li><strong>Select Products</strong> - you wish to be in the pool of cards you draft from and Press "Draft Now"<br>
                        <em>(This will take you to draftmancer.com)</em></li>
                    
                    <li><strong>Choose Draft Type:</strong>
                        <ul>
                            <li><strong>2.a. Bot Draft (default)</strong> - Press "start" on draftmancer and begin drafting.</li>
                            <li><strong>2.b. Human Draft</strong> -
                                <ul>
                                    <li><strong>2.b.i</strong> - decrease the number of bots to 0</li>
                                    <li><strong>2.b.ii</strong> - share the URL with other drafters + wait for them to join</li>
                                    <li><strong>2.b.iii</strong> - Press Start</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    
                    <li><strong>Draft</strong> - select 1 card from each pack until finished.</li>
                    
                    <li><strong>Deckbuild</strong> - choose a selection of cards that create a "legal" deck for your format, moving others to the sideboard</li>
                    
                    <li><strong>Export to ArkhamDb</strong> - choose "Export" > "Card Names" > return to ArkhamVsDraft's "Deck Exporter" and paste it in. Follow instructions for importing to ArkhamDb.com</li>
                    
                    <li><strong>Play</strong> - Import your deck wherever (paper/TTS/octgn) and have each team play through the same scenario concurrently.</li>
                    
                    <li><strong>Scoring</strong> - There are many ways to score and scenarios like Midwinter Gala and Carnevale of Horrors lend themselves to clear scoring. For most others, you can check the "Hunters of the Mythos" community competitions for most scenarios via the Mythos Buster's Discord (<a href="https://discord.com/channels/225349059689447425/1275516418925924448" target="_blank">https://discord.com/channels/225349059689447425/1275516418925924448</a>)</li>
                </ol>
            </div>
        </div>

    <form method="POST" action="/draft">
        <!-- Options Section -->
        <div class="options-section">
            <div class="options-header" onclick="toggleOptions()">
                <h3>Options</h3>
                <span class="options-toggle" id="optionsToggle">â–¼</span>
            </div>
            <div class="options-content" id="optionsContent">
                <div class="options-grid">
                    <div class="option-group">
                        <label class="option-label" for="investigatorsPerPack">Investigators per Pack:</label>
                        <input 
                            type="number" 
                            class="option-input option-number" 
                            id="investigatorsPerPack" 
                            name="investigatorsPerPack"
                            value="3"
                            min="1"
                            max="10"
                        >
                    </div>
                    
                    <div class="option-group">
                        <label class="option-label" for="basicWeaknessesPerPack">Basic Weaknesses per Pack:</label>
                        <input 
                            type="number" 
                            class="option-input option-number" 
                            id="basicWeaknessesPerPack" 
                            name="basicWeaknessesPerPack"
                            value="3"
                            min="1"
                            max="10"
                        >
                    </div>
                    
                    <div class="option-group">
                        <label class="option-label" for="playerCardsPerPack">Player Cards per Pack:</label>
                        <input 
                            type="number" 
                            class="option-input option-number" 
                            id="playerCardsPerPack" 
                            name="playerCardsPerPack"
                            value="15"
                            min="1"
                            max="50"
                        >
                    </div>
                    
                    <div class="option-group">
                        <label class="option-label" for="playerCardPacksPerPlayer">PlayerCard Packs per Player:</label>
                        <input 
                            type="number" 
                            class="option-input option-number" 
                            id="playerCardPacksPerPlayer" 
                            name="playerCardPacksPerPlayer"
                            value="3"
                            min="1"
                            max="10"
                        >
                    </div>
                </div>
                
                <div class="option-group">
                    <label class="option-label" for="cardsToExclude">Cards to Exclude:</label>
                    <textarea 
                        class="option-input option-textarea" 
                        id="cardsToExclude" 
                        name="cardsToExclude"
                        placeholder="1 Knife&#10;1 Emergency Cache&#10;2 Flashlight&#10;1 Magnifying Glass&#10;..."
                    ></textarea>
                </div>
                
                <div class="option-group">
                    <label class="option-label" for="cardsToInclude">Cards to Include:</label>
                    <textarea 
                        class="option-input option-textarea" 
                        id="cardsToInclude" 
                        name="cardsToInclude"
                        placeholder="1 Knife&#10;2 Emergency Cache&#10;1 Flashlight&#10;3 Magnifying Glass&#10;..."
                    ></textarea>
                    <div style="color: #888; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                        Adding a full 'cube' of specific cards with no packs is also supported
                    </div>
                </div>
            </div>
        </div>
        
        <div class="select-all">
            <button type="button" onclick="selectAll()">Select All</button>
            <button type="button" onclick="selectNone()">Select None</button>
        </div>
        
        {% if error %}
        <div class="error-message">
            <h3>Error Loading Pack Data</h3>
            <p>{{ error }}</p>
            <p>Please check your internet connection and try refreshing the page.</p>
        </div>
        {% elif cycles %}
        <div class="cycles-container">
            {% for cycle in cycles %}
            <div class="cycle-group">
                <div class="cycle-header">
                    <input type="checkbox" 
                           id="cycle_{{ cycle.cycle_position }}" 
                           class="cycle-checkbox"
                           onchange="toggleCycle({{ cycle.cycle_position }})">
                    <label for="cycle_{{ cycle.cycle_position }}" class="cycle-label">{{ cycle.cycle_name }}</label>
                </div>
                <div class="cycle-packs">
                    {% for pack_name in cycle.packs %}
                    <div class="pack-item">
                        <input type="checkbox" 
                               id="pack_{{ cycle.cycle_position }}_{{ loop.index }}" 
                               name="sets" 
                               value="{{ pack_name }}"
                               class="pack-checkbox cycle-{{ cycle.cycle_position }}-pack"
                               onchange="updateCycleCheckbox({{ cycle.cycle_position }}); toggleQuantityInput('{{ pack_name }}')">
                        <label for="pack_{{ cycle.cycle_position }}_{{ loop.index }}" class="pack-label">{{ pack_name }}</label>
                        <div class="quantity-controls" id="quantity_controls_{{ pack_name|replace(' ', '_')|replace('-', '_')|replace(':', '')|replace(',', '')|replace('!', '')|replace('.', '') }}">
                            <span class="quantity-label">Qty:</span>
                            <input type="number" 
                                   name="quantity_{{ pack_name }}" 
                                   id="quantity_{{ pack_name|replace(' ', '_')|replace('-', '_')|replace(':', '')|replace(',', '')|replace('!', '')|replace('.', '') }}"
                                   class="quantity-input"
                                   min="1" 
                                   max="10" 
                                   value="1"
                                   disabled>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="error-message">
            <h3>No Pack Data Available</h3>
            <p>Unable to load Arkham Horror pack data. Please try again later.</p>
        </div>
        {% endif %}
        
        <div class="draft-dropdown" style="text-align: center; display: block;">
            <div class="draft-main-button" id="draftMainBtn" style="margin: 0 auto;">
                <div class="draft-button-text" onclick="draftNow()" id="draftTextBtn">DRAFT NOW</div>
                <div class="draft-button-icon" onclick="toggleDraftDropdown(event)" id="draftIconBtn">
                    <span id="draftModeIcon">ðŸ¤–</span>
                    <span class="draft-dropdown-arrow">â–¼</span>
                </div>
            </div>
            <div class="draft-dropdown-content" id="draftDropdownContent">
                <a href="#" class="draft-option" onclick="setDraftMode('bot'); return false;">
                    <span class="draft-option-icon">ðŸ¤–</span>
                    <span>Bot Draft Setup</span>
                </a>
                <a href="#" class="draft-option" onclick="setDraftMode('human'); return false;">
                    <span class="draft-option-icon">ðŸ‘¥</span>
                    <span>Human Draft Setup</span>
                </a>
            </div>
        </div>
        <a href="#" class="download-link disabled" id="downloadLink" onclick="event.preventDefault(); if (!this.classList.contains('disabled')) { downloadDraftFile(); } return false;">download draftmancer file</a>
    </form>

    <div class="footer">
        <p>Please post bug reports and feature requests on <a href="https://github.com/druerridge/arkham-versus-draft" target="_blank">GitHub</a></p>
        <p>The information presented on this site about Arkham Horror: The Card Game, both literal and graphical, is copyrighted by Fantasy Flight Games. This website is not produced, endorsed, supported, or affiliated with Fantasy Flight Games.</p>
    </div>

    <script>
        function toggleOptions() {
            const content = document.getElementById('optionsContent');
            const toggle = document.getElementById('optionsToggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }
        
        function toggleInstructions() {
            const content = document.getElementById('instructionsContent');
            const toggle = document.getElementById('instructionsToggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }
        
        let currentDraftMode = 'bot';
        
        function toggleDraftDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('draftDropdownContent');
            const button = document.getElementById('draftMainBtn');
            
            if (button.classList.contains('disabled')) return;
            
            dropdown.classList.toggle('show');
        }
        
        function setDraftMode(mode) {
            currentDraftMode = mode;
            const iconElement = document.getElementById('draftModeIcon');
            const dropdown = document.getElementById('draftDropdownContent');
            
            iconElement.textContent = mode === 'bot' ? 'ðŸ¤–' : 'ðŸ‘¥';
            dropdown.classList.remove('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('draftDropdownContent');
            const button = document.getElementById('draftMainBtn');
            
            if (!button.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        function selectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.name === 'sets') {
                    checkbox.checked = true;
                    toggleQuantityInput(checkbox.value);
                } else {
                    checkbox.checked = true;
                }
            });
            updateDraftButtonStates();
        }
        
        function selectNone() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                if (checkbox.name === 'sets') {
                    toggleQuantityInput(checkbox.value);
                }
            });
            updateDraftButtonStates();
        }
        
        function toggleCycle(cyclePosition) {
            const cycleCheckbox = document.getElementById(`cycle_${cyclePosition}`);
            const packCheckboxes = document.querySelectorAll(`.cycle-${cyclePosition}-pack`);
            
            packCheckboxes.forEach(checkbox => {
                checkbox.checked = cycleCheckbox.checked;
                toggleQuantityInput(checkbox.value);
            });
            updateDraftButtonStates();
        }
        
        function updateDraftButtonStates() {
            const checkedPacks = document.querySelectorAll('input[name="sets"]:checked');
            const cardsToInclude = document.getElementById('cardsToInclude');
            const draftMainBtn = document.getElementById('draftMainBtn');
            const downloadLink = document.getElementById('downloadLink');
            
            // Enable if packs are selected OR if cards to include has content
            const hasSelectedPacks = checkedPacks.length > 0;
            const hasCardsToInclude = cardsToInclude && cardsToInclude.value.trim().length > 0;
            
            if (hasSelectedPacks || hasCardsToInclude) {
                draftMainBtn.classList.remove('disabled');
                downloadLink.classList.remove('disabled');
            } else {
                draftMainBtn.classList.add('disabled');
                downloadLink.classList.add('disabled');
            }
        }
        
        function toggleQuantityInput(packName) {
            const checkbox = document.querySelector(`input[value="${packName}"]`);
            const sanitizedName = packName.replace(/[\s\-:,.!']/g, '_').replace(/[\.]/g, '');
            const quantityControls = document.getElementById(`quantity_controls_${sanitizedName}`);
            const quantityInput = document.getElementById(`quantity_${sanitizedName}`);
            
            if (checkbox && checkbox.checked) {
                if (quantityControls) {
                    quantityControls.classList.add('enabled');
                }
                if (quantityInput) {
                    quantityInput.disabled = false;
                }
            } else {
                if (quantityControls) {
                    quantityControls.classList.remove('enabled');
                }
                if (quantityInput) {
                    quantityInput.disabled = true;
                    quantityInput.value = 1; // Reset to 1 when unchecked
                }
            }
            
            updateDraftButtonStates();
        }
        
        function updateCycleCheckbox(cyclePosition) {
            const cycleCheckbox = document.getElementById(`cycle_${cyclePosition}`);
            const packCheckboxes = document.querySelectorAll(`.cycle-${cyclePosition}-pack`);
            
            const checkedPacks = Array.from(packCheckboxes).filter(cb => cb.checked).length;
            const totalPacks = packCheckboxes.length;
            
            if (checkedPacks === totalPacks) {
                cycleCheckbox.checked = true;
                cycleCheckbox.indeterminate = false;
            } else if (checkedPacks === 0) {
                cycleCheckbox.checked = false;
                cycleCheckbox.indeterminate = false;
            } else {
                cycleCheckbox.checked = false;
                cycleCheckbox.indeterminate = true;
            }
        }
        
        // Initialize cycle checkboxes on page load
        document.addEventListener('DOMContentLoaded', function() {
            {% for cycle in cycles %}
            updateCycleCheckbox({{ cycle.cycle_position }});
            {% endfor %}
            
            // Initialize quantity inputs
            const packCheckboxes = document.querySelectorAll('input[name="sets"]');
            packCheckboxes.forEach(checkbox => {
                toggleQuantityInput(checkbox.value);
            });
            
            // Add event listener for Cards to Include textarea
            const cardsToInclude = document.getElementById('cardsToInclude');
            if (cardsToInclude) {
                cardsToInclude.addEventListener('input', updateDraftButtonStates);
                cardsToInclude.addEventListener('change', updateDraftButtonStates);
            }
            
            // Initialize button states
            updateDraftButtonStates();
        });
        
        // Draft Now functionality
        async function draftNow() {
            const draftMainBtn = document.getElementById('draftMainBtn');
            const draftTextBtn = document.getElementById('draftTextBtn');
            const dropdown = document.getElementById('draftDropdownContent');
            const form = document.querySelector('form');
            const formData = new FormData(form);
            
            // Close dropdown if open
            dropdown.classList.remove('show');
            
            // Check if button is disabled
            if (draftMainBtn.classList.contains('disabled')) {
                alert('Please select at least one pack to draft or add cards to include.');
                return;
            }
            
            // Add current draft type to form data
            formData.append('draftType', currentDraftMode);
            
            // Check if any sets are selected or cards to include are provided
            const selectedSets = formData.getAll('sets');
            const cardsToIncludeText = formData.get('cardsToInclude') || '';
            if (selectedSets.length === 0 && cardsToIncludeText.trim().length === 0) {
                alert('Please select at least one pack to draft or add cards to include.');
                return;
            }
            
            // Check if Socket.IO is loaded
            if (typeof io === 'undefined') {
                alert('Socket.IO not loaded. Please refresh the page and try again.');
                return;
            }
            
            // Open tab immediately on click (this prevents popup blocking)
            const draftTab = window.open('about:blank', '_blank');
            if (!draftTab) {
                alert('Please allow popups for this site to use Draft Now feature');
                return;
            }
            
            // Show loading content in the tab
            const loadingText = currentDraftMode === 'human' ? 'Preparing human draft...' : 'Preparing bot draft...';
            draftTab.document.write(`
                <html>
                    <head><title>Loading Arkham Draft...</title></head>
                    <body style="font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #1a1a1a; color: #e0e0e0;">
                        <h2>${loadingText}</h2>
                        <p>Please wait while we connect to Draftmancer.</p>
                    </body>
                </html>
            `);
            
            draftMainBtn.classList.add('disabled');
            const originalText = draftTextBtn.textContent;
            draftTextBtn.textContent = 'CONNECTING...';
            
            try {
                const response = await fetch('/draft-now', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate draft');
                }
                
                // Dynamically import and use the draftmancer connection module
                const { generateDraftmancerSession } = await import('/static/draftmancer-connect.js');
                generateDraftmancerSession(data.cubeFile, draftTab, {...data.metadata, draftType: currentDraftMode});
                
                // Show success message without blocking
                console.log(`Starting ${currentDraftMode} draft with ${data.metadata.investigatorsCount} investigators, ${data.metadata.basicWeaknessesCount} basic weaknesses, and ${data.metadata.playerCardsCount} player cards!`);
                
            } catch (error) {
                console.error('Draft Now error:', error);
                alert('Error starting draft: ' + error.message);
                // Close the tab if there was an error
                if (draftTab && !draftTab.closed) {
                    draftTab.close();
                }
            } finally {
                draftMainBtn.classList.remove('disabled');
                draftTextBtn.textContent = originalText;
            }
        }
        
        // Client-side download function
        async function downloadDraftFile() {
            const form = document.querySelector('form');
            const formData = new FormData(form);
            
            // Check validation first
            const selectedSets = formData.getAll('sets');
            const cardsToIncludeText = formData.get('cardsToInclude') || '';
            if (selectedSets.length === 0 && cardsToIncludeText.trim().length === 0) {
                alert('Please select at least one pack to draft or add cards to include.');
                return;
            }
            
            const downloadLink = document.getElementById('downloadLink');
            const originalText = downloadLink.textContent;
            downloadLink.textContent = 'Generating file...';
            downloadLink.classList.add('disabled');
            
            try {
                const response = await fetch('/get-draft-content', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate draft file');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Create and trigger download
                    const blob = new Blob([data.content], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = data.filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Download error:', error);
                alert('Error generating download: ' + error.message);
            } finally {
                downloadLink.textContent = originalText;
                downloadLink.classList.remove('disabled');
            }
        }
    </script>
    
    <!-- Socket.IO for Draftmancer connection -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="/static/draftmancer-connect.js"></script>
</body>
</html>